name: CI - Frontend

on:
  push:
    branches: [main]
    paths:
      - "Frontend/**"
      - ".github/workflows/ci-frontend.yml"
  pull_request:
    branches: [main]
    paths:
      - "Frontend/**"

env:
  IMAGE_NAME: emon110852/quickbite-frontend

jobs:
  build-and-push:
    name: Build, Scan & Push Frontend
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ── 2. Set image tag ─────────────────────────────────────
      - name: Set image tag
        id: tag
        run: |
          
          echo "IMAGE_TAG=sha-${SHA}" >> $GITHUB_OUTPUT

      # ── 3. Login to Docker Hub ───────────────────────────────
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ── 4. Set up Docker Buildx ──────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── 5. Build Docker image ────────────────────────────────
      #     Pass VITE_API_URL as build arg so React knows the backend URL
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./Frontend          # ← context is the Frontend folder
          file: ./Frontend/Dockerfile  # ← Dockerfile inside Frontend/
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── 6. Trivy Security Scan ───────────────────────────────
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
          format: table
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH

      # ── 7. Push to Docker Hub ────────────────────────────────
      - name: Push image to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/build-push-action@v5
        with:
          context: ./Frontend
          file: ./Frontend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── 8. Update Helm values ────────────────────────────────
      - name: Update Helm values with new image tag
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          sed -i "s|tag: .*  # frontend|tag: ${{ steps.tag.outputs.IMAGE_TAG }}  # frontend|" helm/quickbite/values-stg.yaml
          git add helm/quickbite/values-stg.yaml
          git commit -m "ci: update frontend image tag to ${{ steps.tag.outputs.IMAGE_TAG }} [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 9. Summary ───────────────────────────────────────────
      - name: Job Summary
        run: |
          echo "## ✅ Frontend CI Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy Scan**: Passed" >> $GITHUB_STEP_SUMMARY