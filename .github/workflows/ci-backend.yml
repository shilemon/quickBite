name: CI - Backend

on:
  push:
    branches: [main]
    paths:
      - "Backend/**"
      - ".github/workflows/ci-backend.yml"
  pull_request:
    branches: [main]
    paths:
      - "Backend/**"

env:
  IMAGE_NAME: emon110852/quickbite-backend

jobs:
  build-and-push:
    name: Build, Scan & Push Backend
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ── 2. Set image tag to git short SHA ───────────────────
      - name: Set image tag
        id: tag
        run: |
          # Force string format to prevent scientific notation
          SHA=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=sha-${SHA}" >> $GITHUB_OUTPUT

      # ── 3. Login to Docker Hub ───────────────────────────────
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ── 4. Set up Docker Buildx ──────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── 5. Build Docker image ────────────────────────────────
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./Backend          # ← context is the Backend folder
          file: ./Backend/Dockerfile  # ← Dockerfile inside Backend/
          push: false
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      # ── 6. Trivy Security Scan ───────────────────────────────
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
          format: table
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH

      # ── 7. Push to Docker Hub ────────────────────────────────
      - name: Push image to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── 8. Update Helm values (GitOps trigger) ───────────────
      - name: Update Helm values with new image tag
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update staging values
          sed -i "s|tag: .*  # backend|tag: ${{ steps.tag.outputs.IMAGE_TAG }}  # backend|" helm/quickbite/values-stg.yaml

          git add helm/quickbite/values-stg.yaml
          git commit -m "ci: update backend image tag to ${{ steps.tag.outputs.IMAGE_TAG }} [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 9. Summary ───────────────────────────────────────────
      - name: Job Summary
        run: |
          echo "## ✅ Backend CI Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy Scan**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Pushed**: DockerHub" >> $GITHUB_STEP_SUMMARY